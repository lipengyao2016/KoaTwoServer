/**
 * Created by Administrator on 2017/2/7.
 */
"use strict";
const utils= require('commonutils').utils;
const _ = require('lodash');
const request = require('commonutils').request.request;

class BatchQueryUtils {
    constructor() {

        console.log(' BatchQueryUtils -->constructor start.');
        this.max_array_len = 100;


    };

    *batchQuery(reqURL,query)
    {
        let bigArrayKey ;
        for(let key in query)
        {
            let value = query[key];
            if(_.isArray(value) && value.length > this.max_array_len)
            {
                bigArrayKey = key;
                break;
            }
        }


        if(!bigArrayKey)
        {
            let normlRes =  yield request.getRequest(reqURL,query);
            return normlRes.body;
        }
        else
        {
            console.log('batchQuery found bigArrayKey:' + bigArrayKey + ' value.length:' + query[bigArrayKey].length);
            let bigArrayValue = query[bigArrayKey];
            delete query[bigArrayKey];
            let singleBigChunks = _.chunk(bigArrayValue,this.max_array_len);
            let singleQueryReq = singleBigChunks.map(singleChunk=>{
                let singleQs = _.clone(query);
                singleQs[bigArrayKey] = singleChunk;
                singleQs.offset = 0;
                singleQs.limit = this.max_array_len;

                return  request.getRequest(reqURL,singleQs);
            });

            let singleQueryRes = yield singleQueryReq;

            let result =singleQueryRes.reduce((queryRes,{res,body},index)=>{
                if(res.statusCode == 200)
                {
                    if(!queryRes.items)
                    {
                        queryRes = body;
                    }
                    else
                    {
                        queryRes.size += body.size;
                        if(body.items && body.items.length > 0)
                        {
                            queryRes.items = queryRes.items.concat(body.items);
                            console.log('BatchQueryUtils batchQuery  size:',queryRes.size);
                        }
                    }
                }
                else
                {
                    console.log('BatchQueryUtils batchQuery failed!! singleBigChunks:',singleBigChunks[index]);
                }

                return queryRes;

            },{});

            return result;
        }


    }

}

module.exports = BatchQueryUtils;

